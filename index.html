<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Aitube</title>
<style>
body { margin:0; background:#111; color:white; font-family:Arial; }
#authBox, #uploadBox { padding:20px; border-bottom:1px solid #333; }
input { padding:8px; margin:4px; width:200px; }
button { padding:8px 14px; margin:4px; cursor:pointer; }
#videoList { display:flex; flex-wrap:wrap; padding:20px; gap:14px; }
.card { width:260px; background:#222; padding:10px; border-radius:6px; }
video { width:100%; border-radius:6px; }
.commentBox { margin-top:10px; }
.commentBox input { width:80%; }
</style>
</head>
<body>
<div id="authBox">
<h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</h2>
<input id="email" placeholder="Email" />
<input id="pass" type="password" placeholder="Password" />
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button onclick="login()">–í—Ö–æ–¥</button>
<p id="userInfo"></p>
</div>

<div id="uploadBox" style="display:none;">
<h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h3>
<input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
<input id="file" type="file" accept="video/mp4" />
<button onclick="uploadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div id="videoList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  databaseURL: "https://aitube-8e681-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let currentUser = null;

function saveUser(u){ localStorage.setItem("aitubeUser", JSON.stringify(u)); }
function loadUser(){ return JSON.parse(localStorage.getItem("aitubeUser")); }
currentUser = loadUser();
if(currentUser){ onLogin(); }

window.register = function(){
  const email = email.value.replace(/\./g, "_");
  const passw = pass.value;
  const id = Date.now();
  set(ref(db, "users/" + email), { id, email, pass: passw, subs:{} }).then(()=>{
    currentUser = { email };
    saveUser(currentUser);
    onLogin();
  });
}

window.login = function(){
  const email2 = email.value.replace(/\./g, "_");
  onValue(ref(db, "users/"+email2), sn=>{
    const d = sn.val();
    if(!d) return;
    if(d.pass === pass.value){ currentUser={email:email2}; saveUser(currentUser); onLogin(); }
  }, {onlyOnce:true});
}

function onLogin(){
  userInfo.innerText = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + currentUser.email;
  uploadBox.style.display = "block";
}

window.uploadVideo = function(){
  const fileInput = document.getElementById("file");
  const f = fileInput.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const url = e.target.result;
    const id = push(ref(db, "videos")).key;
    set(ref(db, "videos/"+id), {
      id,
      title: title.value,
      owner: currentUser.email,
      data: url,
      likes:0,
      dislikes:0,
      comments:{},
      subs:{}
    });
  };
  reader.readAsDataURL(f);
}

onValue(ref(db, "videos"), snap=>{
  const vids = snap.val();
  videoList.innerHTML="";
  if(!vids) return;
  Object.values(vids).forEach(v=>{
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <video src="${v.data}" controls></video>
      <h4>${v.title}</h4>
      <p>–ê–≤—Ç–æ—Ä: ${v.owner}</p>
      <button onclick="like('${v.id}')">üëç ${v.likes||0}</button>
      <button onclick="dislike('${v.id}')">üëé ${v.dislikes||0}</button>
      <button onclick="sub('${v.owner}')">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
      <div class='commentBox'>
        <input id='c_${v.id}' placeholder='–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' />
        <button onclick="comment('${v.id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div>${renderComments(v.comments)}</div>
    `;
    videoList.appendChild(c);
  });
});

window.like = function(id){
  update(ref(db, "videos/"+id), {likes: (Math.random()*0).toString(),});
  onValue(ref(db, "videos/"+id), s=>{
    const d=s.val();
    update(ref(db, "videos/"+id), {likes:(d.likes||0)+1});
  },{onlyOnce:true});
}

window.dislike = function(id){
  onValue(ref(db, "videos/"+id), s=>{
    const d=s.val();
    update(ref(db, "videos/"+id), {dislikes:(d.dislikes||0)+1});
  },{onlyOnce:true});
}

window.comment = function(id){
  const text = document.getElementById("c_"+id).value;
  if(!text) return;
  const cid = Date.now();
  set(ref(db, `videos/${id}/comments/${cid}`), {
    user: currentUser.email,
    text
  });
}

window.sub = function(author){
  update(ref(db, `users/${currentUser.email}/subs/${author}`), true);
}

function renderComments(c){
  if(!c) return "";
  return Object.values(c).map(x=>`<p><b>${x.user}:</b> ${x.text}</p>`).join("");
}
</script>

</body>
</html>
