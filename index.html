<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Y ‚Äî —Å–æ—Ü—Å–µ—Ç—å + TikHTML</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* ========= –û–±—â–µ–µ ========= */
:root{--bg:#0d0d0d;--card:#181818;--muted:#999;--accent:#1da1f2}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif;line-height:1.4}
.container{max-width:900px;margin:20px auto;padding:10px}

/* ========= –¢–æ–ø–±–∞—Ä ========= */
#topbar{display:flex;gap:8px;justify-content:center;padding:12px;background:#0b0b0b;border-bottom:1px solid #151515;position:sticky;top:0;z-index:40}
#topbar button{background:transparent;border:1px solid #222;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
#topbar .primary{background:var(--accent);border-color:transparent}

/* ========= –ë–ª–æ–∫–∏ ========= */
.hidden{display:none}
.card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.4)}
.row{display:flex;align-items:center;gap:10px}
.avatar{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:22px}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.input,textarea,select{width:100%;padding:10px;border-radius:10px;border:none;background:#111;color:#fff;margin-top:8px}
textarea{min-height:110px;resize:vertical}

/* ========= –õ–µ–Ω—Ç–∞ / –ø—Ä–æ–µ–∫—Ç ========= */
.tweet,.project{background:#141414;padding:12px;border-radius:10px;margin-bottom:10px}
.tweet img{max-width:100%;border-radius:10px;margin-top:8px}
.reacts{margin-top:10px}
.reacts span{margin-right:12px;cursor:pointer;font-size:18px;opacity:.95}
.reacts span:hover{transform:scale(1.08)}

.iframe-wrap{margin-top:10px;border-radius:10px;overflow:hidden;border:1px solid #222}

/* ========= –ü—Ä–æ—Ñ–∏–ª—å ========= */
.profile-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.small{font-size:13px;color:var(--muted)}
.link{color:var(--accent);cursor:pointer}

/* ========= Intro ========= */
#introOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.85));z-index:60}
#introCard{width:90%;max-width:720px;background:linear-gradient(180deg,#0f1720,#081018);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,.04);text-align:center}
#introCard h1{margin:0 0 8px 0}
#introCard p{color:#c9d3df;margin-bottom:18px}

/* ========= –ê–¥–∞–ø—Ç–∏–≤ ========= */
@media (max-width:720px){ .container{padding:12px} .avatar{width:46px;height:46px;font-size:18px} }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar" class="hidden">
  <button onclick="openFeed()">–õ–µ–Ω—Ç–∞</button>
  <button onclick="openCreateTweet()">–°–æ–∑–¥–∞—Ç—å —Ç–≤–∏—Ç</button>
  <button onclick="openTikHTML()">TikHTML</button>
  <button onclick="openCreateTik()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  <button onclick="openSubscriptions()">–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</button>
  <button id="btnLogout" class="hidden" onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<div class="container">

  <!-- REG -->
  <div id="register" class="card">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="regNick" class="input" placeholder="–ù–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: tochara)">
    <input id="regPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    <input id="regPass2" class="input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      <button class="btn" onclick="showLogin()">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="card hidden">
    <h2>–í—Ö–æ–¥</h2>
    <input id="logNick" class="input" placeholder="–ù–∏–∫">
    <input id="logPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" onclick="login()">–í–æ–π—Ç–∏</button>
      <button class="btn" onclick="showRegister()">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- CREATE TWEET -->
  <div id="createTweet" class="card hidden">
    <h3>–°–æ–∑–¥–∞—Ç—å —Ç–≤–∏—Ç</h3>
    <textarea id="tweetText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" class="input"></textarea>
    <input id="tweetImg" class="input" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn primary" onclick="sendTweet()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      <button class="btn" onclick="openFeed()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- FEED -->
  <div id="feed" class="hidden"></div>

  <!-- TIKHTML LIST -->
  <div id="tikhtml" class="hidden"></div>

  <!-- CREATE TIK -->
  <div id="createTik" class="card hidden">
    <h3>–ù–æ–≤—ã–π TikHTML –ø—Ä–æ–µ–∫—Ç</h3>
    <input id="tikName" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
    <textarea id="tikCode" class="input" placeholder="HTML –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –º–æ–∂–Ω–æ CSS/JS –≤–Ω—É—Ç—Ä–∏"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn primary" onclick="saveTikHTML()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      <button class="btn" onclick="openTikHTML()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileView" class="hidden"></div>

  <!-- SUBSCRIPTIONS -->
  <div id="subscriptionsView" class="hidden card"></div>

</div>

<!-- INTRO OVERLAY -->
<div id="introOverlay" class="">
  <div id="introCard">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Y + TikHTML</h1>
    <p>–ü—É–±–ª–∏–∫—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø–∏—Å–∏, –¥–æ–±–∞–≤–ª—è–π HTML-–ø—Ä–æ–µ–∫—Ç—ã (–∏–≥—Ä—ã/–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è) –ø—Ä—è–º–æ –≤ –ª–µ–Ω—Ç—É, —Å–º–æ—Ç—Ä–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn primary" onclick="startApp()">–ù–∞—á–∞—Ç—å</button>
      <button class="btn" onclick="skipIntro()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–≤—Å–µ–≥–¥–∞)</button>
    </div>
  </div>
</div>

<script>
/* ================== –ö–æ–Ω—Ñ–∏–≥ Firebase ==================
   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–≤–æ–π URL –±–∞–∑—ã:
   https://aitube-8e681-default-rtdb.firebaseio.com/
   –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –∑–∞–º–µ–Ω–∏ dbUrl –Ω–∞ —Å–≤–æ–π.
==================================================== */
const dbUrl = "https://aitube-8e681-default-rtdb.firebaseio.com/";

/* —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å RTDB */
async function fb(path, method = "GET", data = null) {
  const url = dbUrl + path + ".json";
  const opts = { method };
  if (data !== null) opts.body = JSON.stringify(data);
  const res = await fetch(url, opts);
  return await res.json();
}

/* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
const topbar = document.getElementById("topbar");
const regDiv = document.getElementById("register");
const loginDiv = document.getElementById("login");
const feedDiv = document.getElementById("feed");
const createTweetDiv = document.getElementById("createTweet");
const tikDiv = document.getElementById("tikhtml");
const createTikDiv = document.getElementById("createTik");
const profileView = document.getElementById("profileView");
const subsView = document.getElementById("subscriptionsView");
const introOverlay = document.getElementById("introOverlay");
const btnLogout = document.getElementById("btnLogout");

/* helpers */
function hideAllMain(){
  regDiv.classList.add("hidden");
  loginDiv.classList.add("hidden");
  feedDiv.classList.add("hidden");
  createTweetDiv.classList.add("hidden");
  tikDiv.classList.add("hidden");
  createTikDiv.classList.add("hidden");
  profileView.classList.add("hidden");
  subsView.classList.add("hidden");
}
function showTopbar(show){
  if(show) topbar.classList.remove("hidden"); else topbar.classList.add("hidden");
}

/* ========== Intro logic ========= */
function startApp(){
  introOverlay.style.display = "none";
  localStorage.introSeen = "1";
}
function skipIntro(){
  localStorage.introSeen = "1";
  introOverlay.style.display = "none";
}
if(localStorage.introSeen === "1") introOverlay.style.display = "none";

/* ========== Avatar generation ========= */
function genAvatar(nick){
  const ch = (nick && nick.length>0) ? nick.charCodeAt(0) : 65;
  const hue = (ch * 47) % 360;
  return { bg: `hsl(${hue} 70% 45%)`, letter: (nick||"?").charAt(0).toUpperCase() };
}

/* ========== Registration / Login / Logout ========== */
async function register(){
  const nick = document.getElementById("regNick").value.trim();
  const pass = document.getElementById("regPass").value;
  const pass2 = document.getElementById("regPass2").value;
  if(!nick || !pass || pass !== pass2){ alert("–û—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å –Ω–∏–∫/–ø–∞—Ä–æ–ª–∏"); return; }

  const users = await fb("users");
  if(users && users[nick]){ alert("–ù–∏–∫ –∑–∞–Ω—è—Ç"); return; }

  const userObj = { pass, react: {}, follows: {} };
  await fb("users/" + nick, "PUT", userObj);
  alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω");
  showLogin();
}

function showLogin(){ regDiv.classList.add("hidden"); loginDiv.classList.remove("hidden"); }
function showRegister(){ loginDiv.classList.add("hidden"); regDiv.classList.remove("hidden"); }

async function login(){
  const nick = document.getElementById("logNick").value.trim();
  const pass = document.getElementById("logPass").value;
  if(!nick || !pass){ alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ"); return; }

  const user = await fb("users/" + nick);
  if(!user || user.pass !== pass){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å"); return; }

  localStorage.nick = nick;
  initAfterLogin();
}

/* Logout */
function logout(){
  delete localStorage.nick;
  btnLogout.classList.add("hidden");
  showTopbar(false);
  hideAllMain();
  regDiv.classList.remove("hidden");
  // show intro again only if not skipped permanently (we don't reset localStorage.introSeen)
}

/* –ê–≤—Ç–æ-–≤—Ö–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å) */
window.addEventListener("load", async () => {
  if(localStorage.nick){
    const user = await fb("users/" + localStorage.nick);
    if(user){ initAfterLogin(); return; }
    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî –æ—á–∏—Å—Ç–∏–º
    delete localStorage.nick;
  }
  // –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–≥/–ª–æ–≥–∏–Ω
  regDiv.classList.remove("hidden");
});

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ */
function initAfterLogin(){
  showTopbar(true);
  btnLogout.classList.remove("hidden");
  regDiv.classList.add("hidden");
  loginDiv.classList.add("hidden");
  openFeed();
}

/* ========== TWEETS ========= */
async function sendTweet(){
  const text = document.getElementById("tweetText").value.trim();
  const img = document.getElementById("tweetImg").value?.trim();
  const nick = localStorage.nick;
  if(!nick) return alert("–í–æ–π–¥–∏—Ç–µ");
  if(!text && !img) return alert("–ü—É—Å—Ç–æ–π —Ç–≤–∏—Ç");

  await fb("tweets", "POST", { nick, text, img: img || "", time: Date.now(), reactions: { like:0, laugh:0, wow:0 } });
  document.getElementById("tweetText").value = "";
  document.getElementById("tweetImg").value = "";
  openFeed();
}

/* –†–µ–∞–∫—Ü–∏–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ */
async function react(tweetId, type){
  const nick = localStorage.nick;
  if(!nick) return alert("–í–æ–π–¥–∏—Ç–µ");

  const [tweet, user] = await Promise.all([ fb("tweets/" + tweetId), fb("users/" + nick) ]);
  if(!tweet || !user) return;

  user.react = user.react || {};
  const prev = user.react[tweetId] || null;

  if(prev === type){
    // —Å–Ω—è—Ç—å
    tweet.reactions[type] = Math.max(0, (tweet.reactions[type] || 0) - 1);
    delete user.react[tweetId];
  } else {
    if(prev){
      tweet.reactions[prev] = Math.max(0, (tweet.reactions[prev] || 0) - 1);
    }
    tweet.reactions[type] = (tweet.reactions[type] || 0) + 1;
    user.react[tweetId] = type;
  }

  // –∑–∞–ø–∏—Å–∞—Ç—å –æ–±–∞
  await fb("tweets/" + tweetId, "PUT", tweet);
  await fb("users/" + nick, "PUT", user);
  await loadFeed(); // –æ–±–Ω–æ–≤–∏–º
}

/* ========== LOAD FEED ========= */
async function loadFeed(){
  hideAllMain();
  feedDiv.classList.remove("hidden");
  feedDiv.innerHTML = "";

  const tweets = await fb("tweets");
  if(!tweets){ feedDiv.innerHTML = `<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–≤–∏—Ç–æ–≤</div>`; return; }

  const arr = Object.entries(tweets).sort((a,b) => b[1].time - a[1].time);
  for(const [id, t] of arr){
    const av = genAvatar(t.nick);
    const el = document.createElement("div");
    el.className = "tweet card";
    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="avatar" style="background:${av.bg};">${av.letter}</div>
          <div>
            <div style="font-weight:700;cursor:pointer" onclick="openProfile('${t.nick}')">${t.nick}</div>
            <div class="small">${new Date(t.time).toLocaleString()}</div>
          </div>
        </div>
      </div>
      <div style="margin-top:8px">${escapeHtml(t.text || "")}</div>
      ${t.img ? `<img src="${escapeAttr(t.img)}" alt="img">` : ""}
      <div class="reacts small">
        <span onclick="react('${id}','like')">‚ù§Ô∏è ${t.reactions?.like||0}</span>
        <span onclick="react('${id}','laugh')">üòÇ ${t.reactions?.laugh||0}</span>
        <span onclick="react('${id}','wow')">üòÆ ${t.reactions?.wow||0}</span>
      </div>
    `;
    feedDiv.appendChild(el);
  }
}

/* ========= TikHTML (projects) ========= */
async function saveTikHTML(){
  const name = document.getElementById("tikName").value.trim();
  const code = document.getElementById("tikCode").value;
  const nick = localStorage.nick;
  if(!nick) return alert("–í–æ–π–¥–∏—Ç–µ");
  if(!name || !code) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

  await fb("tikhtml", "POST", { nick, name, code, time: Date.now() });
  document.getElementById("tikName").value = "";
  document.getElementById("tikCode").value = "";
  openTikHTML();
}

/* –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ iframe ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º element.srcdoc (–Ω–µ innerHTML!) —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ */
async function loadTikHTML(){
  hideAllMain();
  tikDiv.classList.remove("hidden");
  tikDiv.innerHTML = "";

  const projects = await fb("tikhtml");
  if(!projects){ tikDiv.innerHTML = `<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>`; return; }
  const arr = Object.entries(projects).sort((a,b)=>b[1].time - a[1].time);

  for(const [id,p] of arr){
    const av = genAvatar(p.nick);
    const card = document.createElement("div");
    card.className = "project card";
    // header
    const header = document.createElement("div");
    header.className = "row";
    header.style.justifyContent = "space-between";
    header.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <div class="avatar" style="background:${av.bg};">${av.letter}</div>
        <div>
          <div style="font-weight:700;cursor:pointer" onclick="openProfile('${p.nick}')">${p.nick}</div>
          <div class="small">${new Date(p.time).toLocaleString()}</div>
        </div>
      </div>
      <div style="text-align:right"><div style="font-weight:700">${escapeHtml(p.name)}</div></div>
    `;
    card.appendChild(header);

    // iframe wrapper
    const wrap = document.createElement("div");
    wrap.className = "iframe-wrap";
    const iframe = document.createElement("iframe");
    // –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å srcdoc –Ω–∞–ø—Ä—è–º—É—é ‚Äî —Å—é–¥–∞ –ø–æ–º–µ—â–∞–µ–º —á–∏—Å—Ç—ã–π HTML (–±–µ–∑ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)
    iframe.srcdoc = p.code || "<div style='padding:16px;color:#000'>Empty</div>";
    wrap.appendChild(iframe);
    card.appendChild(wrap);

    // footer (open project in new window)
    const footer = document.createElement("div");
    footer.style.marginTop = "8px";
    footer.className = "small";
    const openBtn = document.createElement("button");
    openBtn.className = "btn";
    openBtn.textContent = "–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ";
    openBtn.onclick = () => {
      // —Å–æ–∑–¥–∞—ë–º blob URL —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å srcdoc content –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
      const blob = new Blob([p.code], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      setTimeout(()=>URL.revokeObjectURL(url), 20000);
    };
    footer.appendChild(openBtn);
    card.appendChild(footer);

    tikDiv.appendChild(card);
  }
}

/* ========= PROFILE & SUBSCRIPTIONS ========= */
async function openProfile(nick){
  hideAllMain();
  profileView.classList.remove("hidden");
  profileView.innerHTML = "";
  const user = await fb("users/" + nick);
  if(!user) { profileView.innerHTML = `<div class="card">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`; return; }

  const av = genAvatar(nick);
  const me = localStorage.nick;

  // header
  const header = document.createElement("div");
  header.className = "card profile-head";
  header.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px">
      <div class="avatar" style="background:${av.bg}">${av.letter}</div>
      <div>
        <div style="font-weight:700">${nick}</div>
        <div class="small">${Object.keys(user.follows||{}).length} –ø–æ–¥–ø–∏—Å–æ–∫</div>
      </div>
    </div>
  `;
  profileView.appendChild(header);

  // actions (follow/unfollow or edit)
  const actions = document.createElement("div");
  actions.className = "card";
  if(me && me !== nick){
    const meUser = await fb("users/" + me);
    const isFollowing = !!(meUser && meUser.follows && meUser.follows[nick]);
    const btn = document.createElement("button");
    btn.className = "btn primary";
    btn.textContent = isFollowing ? "–û—Ç–ø–∏—Å–∞—Ç—å—Å—è" : "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
    btn.onclick = async () => {
      meUser.follows = meUser.follows || {};
      if(isFollowing){
        delete meUser.follows[nick];
      } else {
        meUser.follows[nick] = true;
      }
      await fb("users/" + me, "PUT", meUser);
      openProfile(nick); // –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    };
    actions.appendChild(btn);
  } else if(!me){
    const info = document.createElement("div");
    info.textContent = "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å";
    actions.appendChild(info);
  } else {
    const info = document.createElement("div");
    info.textContent = "–≠—Ç–æ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å";
    actions.appendChild(info);
  }
  profileView.appendChild(actions);

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã (tikhtml)
  const projectsTitle = document.createElement("div");
  projectsTitle.className = "card";
  projectsTitle.innerHTML = `<b>–ü—Ä–æ–µ–∫—Ç—ã ${nick}</b>`;
  profileView.appendChild(projectsTitle);

  const allProjects = await fb("tikhtml");
  if(allProjects){
    const arr = Object.entries(allProjects).filter(([,p]) => p.nick === nick).sort((a,b)=>b[1].time - a[1].time);
    if(arr.length === 0){
      const empty = document.createElement("div"); empty.className = "card small"; empty.textContent = "–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤";
      profileView.appendChild(empty);
    } else {
      for(const [id,p] of arr){
        const card = document.createElement("div");
        card.className = "card project";
        const av2 = genAvatar(p.nick);
        card.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px">
            <div class="avatar" style="background:${av2.bg}">${av2.letter}</div>
            <div>
              <div style="font-weight:700">${escapeHtml(p.name)}</div>
              <div class="small">${new Date(p.time).toLocaleString()}</div>
            </div>
          </div>
        `;
        const wrap = document.createElement("div"); wrap.className = "iframe-wrap";
        const iframe = document.createElement("iframe"); iframe.srcdoc = p.code || "<div></div>";
        wrap.appendChild(iframe);
        card.appendChild(wrap);
        profileView.appendChild(card);
      }
    }
  }

  // –¢–≤–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const tweetsTitle = document.createElement("div");
  tweetsTitle.className = "card";
  tweetsTitle.innerHTML = `<b>–¢–≤–∏—Ç—ã ${nick}</b>`;
  profileView.appendChild(tweetsTitle);

  const tweets = await fb("tweets");
  const arrTweets = tweets ? Object.entries(tweets).filter(([,t]) => t.nick === nick).sort((a,b)=>b[1].time - a[1].time) : [];
  if(arrTweets.length === 0){
    const empty = document.createElement("div"); empty.className = "card small"; empty.textContent = "–ù–µ—Ç —Ç–≤–∏—Ç–æ–≤";
    profileView.appendChild(empty);
  } else {
    for(const [id,t] of arrTweets){
      const card = document.createElement("div"); card.className = "card tweet";
      card.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px">
          <div class="avatar" style="background:${av.bg}">${av.letter}</div>
          <div>
            <div style="font-weight:700">${t.nick}</div>
            <div class="small">${new Date(t.time).toLocaleString()}</div>
          </div>
        </div>
        <div style="margin-top:8px">${escapeHtml(t.text||"")}</div>
        ${t.img ? `<img src="${escapeAttr(t.img)}">` : ""}
      `;
      profileView.appendChild(card);
    }
  }
}

/* –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–¥–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
async function openSubscriptions(){
  hideAllMain();
  subsView.classList.remove("hidden");
  subsView.innerHTML = "<h3>–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</h3>";

  const me = localStorage.nick;
  if(!me){ subsView.innerHTML += "<div class='small card'>–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏</div>"; return; }
  const user = await fb("users/" + me);
  const follows = user && user.follows ? Object.keys(user.follows) : [];
  if(follows.length === 0){ subsView.innerHTML += "<div class='card small'>–í—ã –Ω–∏–∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã</div>"; return; }

  // –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
  for(const u of follows){
    const av = genAvatar(u);
    const row = document.createElement("div"); row.className = "card";
    row.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="openProfile('${u}')">
          <div class="avatar" style="background:${av.bg}">${av.letter}</div>
          <div><div style="font-weight:700">${u}</div></div>
        </div>
        <div>
          <button class="btn" onclick="unfollow('${u}')">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
        </div>
      </div>
    `;
    subsView.appendChild(row);
  }
}

/* unfollow helper */
async function unfollow(target){
  const me = localStorage.nick;
  if(!me) return;
  const meUser = await fb("users/" + me);
  if(!meUser || !meUser.follows) return;
  delete meUser.follows[target];
  await fb("users/" + me, "PUT", meUser);
  openSubscriptions();
}

/* ========= –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–∞—è ========= */
function openFeed(){ loadFeed(); }
function openCreateTweet(){ hideAllMain(); createTweetDiv.classList.remove("hidden"); }
function openTikHTML(){ loadTikHTML(); }
function openCreateTik(){ hideAllMain(); createTikDiv.classList.remove("hidden"); }

/* ========== –£—Ç–∏–ª–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ ========= */
function escapeHtml(s){
  if(!s) return "";
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function escapeAttr(s){
  if(!s) return "";
  return s.replaceAll('"','%22');
}

/* ========== –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä–æ–µ–º feed –µ—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ========== */
</script>
</body>
</html>
