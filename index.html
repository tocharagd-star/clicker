<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft HTML Firebase</title>
<style>
body {
    margin: 0;
    overflow: hidden;
    background: #87CEEB;
    touch-action: none;
}
#canvas {
    width: 100vw;
    height: 100vh;
    background: #87CEEB;
    display: block;
}
#ui {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 99;
    font-family: Arial;
}
button {
    padding: 10px;
    font-size: 16px;
    margin-bottom: 5px;
}
#servers {
    background: white;
    padding: 10px;
    border-radius: 5px;
    max-width: 200px;
}
.joystick {
    position: fixed;
    bottom: 50px;
    left: 50px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    touch-action: none;
}
.joystick-inner {
    position: absolute;
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 50%;
    left: 35px;
    top: 35px;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="ui">
    <button onclick="createServer()">Создать сервер</button>
    <div id="servers"></div>
</div>

<div class="joystick" id="joy">
    <div class="joystick-inner" id="joyInner"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
//////////////////////////
// FIREBASE INIT
//////////////////////////
firebase.initializeApp({
    databaseURL: "https://clicker-3044c-default-rtdb.firebaseio.com/"
});

const db = firebase.database();

//////////////////////////
// GLOBAL
//////////////////////////
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let serverID = null;
let playerID = "p" + Math.random().toString(36).substr(2,6);

let world = [];
let players = {};

let px = 0, py = 0;
let vx = 0, vy = 0;
let onGround = false;

//////////////////////////
// GENERATE SIMPLE WORLD
//////////////////////////
function genWorld() {
    world = [];
    for (let x = -30; x <= 30; x++) {
        world.push({x, y:10, type:1});
    }
}

//////////////////////////
// DRAW
//////////////////////////
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    let scale = 30;

    // blocks
    for (let b of world) {
        ctx.fillStyle = b.type === 1 ? "#8B4513" : "#00FF00";
        ctx.fillRect(
            canvas.width/2 + (b.x - px)*scale,
            canvas.height/2 + (b.y - py)*scale,
            scale, scale
        );
    }

    // players
    for (let id in players) {
        let pl = players[id];
        ctx.fillStyle = id === playerID ? "yellow" : "red";
        ctx.fillRect(
            canvas.width/2 + (pl.x - px)*scale,
            canvas.height/2 + (pl.y - py)*scale - 30,
            20, 30
        );
    }

    requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

//////////////////////////
// PHYSICS
//////////////////////////
setInterval(()=> {
    vy += 0.05;
    px += vx;
    py += vy;

    // collide with ground
    for (let b of world) {
        if (Math.abs(px - b.x) < 0.5 && Math.abs(py - b.y) < 1) {
            py = b.y - 1;
            vy = 0;
            onGround = true;
        }
    }

    if (serverID) {
        db.ref("servers/"+serverID+"/players/"+playerID).set({
            x: px,
            y: py
        });
    }
}, 20);

//////////////////////////
// INPUT (PC)
//////////////////////////
let keys = {};
document.addEventListener("keydown", e=> keys[e.key] = true);
document.addEventListener("keyup", e=> keys[e.key] = false);

setInterval(()=>{
    vx = 0;
    if (keys["a"] || keys["ArrowLeft"]) vx = -0.1;
    if (keys["d"] || keys["ArrowRight"]) vx = 0.1;
    if ((keys["w"] || keys["ArrowUp"]) && onGround) {
        vy = -0.35;
        onGround = false;
    }
}, 20);

//////////////////////////
// INPUT (TOUCH JOYSTICK)
//////////////////////////
let joy = document.getElementById("joy");
let joyInner = document.getElementById("joyInner");
let jCenter = {x: 60, y: 60};

joy.addEventListener("touchmove", e=>{
    let t = e.touches[0];
    let rect = joy.getBoundingClientRect();
    let x = t.clientX - rect.left;
    let y = t.clientY - rect.top;

    let dx = x - jCenter.x;
    let dy = y - jCenter.y;

    if (dx > 30) vx = 0.1;
    else if (dx < -30) vx = -0.1;
    else vx = 0;

    if (dy < -30 && onGround) {
        vy = -0.35;
        onGround = false;
    }

    joyInner.style.left = (x-25)+"px";
    joyInner.style.top = (y-25)+"px";
});

joy.addEventListener("touchend", ()=>{
    vx = 0;
    joyInner.style.left = "35px";
    joyInner.style.top = "35px";
});

//////////////////////////
// SERVERS LIST
//////////////////////////
db.ref("servers").on("value", snap=>{
    let list = snap.val() || {};
    let box = document.getElementById("servers");
    box.innerHTML = "";

    for (let id in list) {
        let b = document.createElement("button");
        b.innerHTML = "Сервер " + id;
        b.onclick = ()=> joinServer(id);
        box.appendChild(b);
    }
});

//////////////////////////
// CREATE SERVER
//////////////////////////
function createServer() {
    serverID = "s" + Math.random().toString(36).substr(2,4);
    genWorld();

    db.ref("servers/"+serverID).set({
        world: world,
        players:{}
    });

    listenPlayers();
}

//////////////////////////
// JOIN SERVER
//////////////////////////
function joinServer(id) {
    serverID = id;

    db.ref("servers/"+id+"/world").once("value", snap=>{
        world = snap.val() || [];
    });

    listenPlayers();
}

function listenPlayers() {
    db.ref("servers/"+serverID+"/players").on("value", snap=>{
        players = snap.val() || {};
    });

    db.ref("servers/"+serverID+"/players/"+playerID).set({
        x: px,
        y: py
    });

    db.ref("servers/"+serverID+"/players/"+playerID).onDisconnect().remove();
}
</script>

</body>
</html>
