<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WebApp</title>
<style>
 body{margin:0;font-family:Arial;background:#121212;color:white;overflow-x:hidden}
 .center{display:flex;justify-content:center;align-items:center}
 .btn{padding:10px 18px;background:#333;border-radius:8px;cursor:pointer}
 .input{padding:10px;border-radius:8px;border:none;width:90%}
 .card{background:#1e1e1e;padding:15px;border-radius:12px;margin:10px 0}
 .slide{animation:fade .4s}
 @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div id="intro" class="center" style="height:100vh;flex-direction:column;text-align:center;">
 <h1 style="font-size:40px;">Welcome</h1>
 <div class="btn" onclick="closeIntro()">Start</div>
</div>

<div id="auth" class="center slide" style="height:100vh;flex-direction:column;display:none;">
 <h2>Login / Register</h2>
 <input id="authUser" class="input" placeholder="Username">
 <input id="authPass" class="input" placeholder="Password" type="password" style="margin-top:10px;">
 <div class="btn" style="margin-top:10px" onclick="auth()">Continue</div>
</div>

<div id="main" style="display:none;padding:20px;">
 <h2>Feed</h2>
 <div class="btn" onclick="showCreateGame()">Создать проект (TikHTML)</div>
 <div id="feed"></div>
 <h2>Сообщения</h2>
 <div class="btn" onclick="openMessages()">Открыть чаты</div>
</div>

<div id="createGame" style="display:none;padding:20px;">
 <h2>Новый TikHTML проект</h2>
 <input id="projName" class="input" placeholder="Название"><br><br>
 <textarea id="projCode" class="input" style="height:200px" placeholder="HTML код"></textarea><br><br>
 <div class="btn" onclick="publishGame()">Опубликовать</div>
</div>

<div id="viewer" style="display:none;padding:0;margin:0;height:100vh;background:black;">
 <iframe id="viewerFrame" style="width:100%;height:100%;border:none;"></iframe>
</div>

<div id="profile" style="display:none;padding:20px;">
 <h2 id="profileName"></h2>
 <div class="btn" onclick="follow()">Подписаться</div>
 <h3>Подписки:</h3>
 <div id="subs"></div>
 <h3>Проекты пользователя:</h3>
 <div id="userProjects"></div>
</div>

<div id="messages" style="display:none;padding:20px;">
 <h2>Личные и групповые чаты</h2>
 <div class="btn" onclick="newChat()">Создать чат</div>
 <div id="chatList"></div>
 <div id="chatWindow" style="margin-top:20px;"></div>
</div>

<script>
let DB = {users:{}, posts:[], chats:[]};
let me = null;

function save(){localStorage.setItem("db",JSON.stringify(DB));localStorage.setItem("me",me);} 
function load(){let d=localStorage.getItem("db");if(d)DB=JSON.parse(d);me=localStorage.getItem("me");}
load();

function closeIntro(){intro.style.display="none";auth.style.display="flex";}

function auth(){let u=authUser.value.trim(),p=authPass.value.trim();if(!u||!p)return;
 if(!DB.users[u]) DB.users[u]={password:p,subs:[],projects:[]};
 if(DB.users[u].password!==p) return;
 me=u; save();
 showMain();
}

function showMain(){auth.style.display="none";main.style.display="block";renderFeed();}

function showCreateGame(){main.style.display="none";createGame.style.display="block";}

function publishGame(){let n=projName.value.trim();let c=projCode.value;
 if(!n||!c)return;
 let proj={owner:me,name:n,code:c,id:Date.now()};
 DB.users[me].projects.push(proj);
 DB.posts.push(proj);
 save();
 createGame.style.display="none";showMain();
}

function renderFeed(){feed.innerHTML="";
 DB.posts.slice().reverse().forEach(p=>{
  let d=document.createElement("div");d.className="card slide";
  d.innerHTML=`<b>${p.name}</b><br>Автор: <span style='cursor:pointer;color:#7cf;' onclick='openProfile("${p.owner}")'>${p.owner}</span><br><div class='btn' onclick='openViewer(${p.id})'>Открыть</div>`;
  feed.appendChild(d);
 });
}

function openViewer(id){let p=DB.posts.find(x=>x.id==id);
 viewer.style.display="block";main.style.display="none";
 let blob=new Blob([p.code],{type:"text/html"});
 viewerFrame.src=URL.createObjectURL(blob);
}

function openProfile(u){main.style.display="none";profile.style.display="block";
 profileName.textContent=u;
 let user=DB.users[u];
 subs.innerHTML=user.subs.join(", ") || "нет";
 userProjects.innerHTML="";
 user.projects.forEach(p=>{
  let d=document.createElement("div");d.className="card";
  d.innerHTML=`${p.name} <div class='btn' onclick='openViewer(${p.id})'>Открыть</div>`;
  userProjects.appendChild(d);
 });
}

function follow(){let s=DB.users[me].subs;
 if(!s.includes(profileName.textContent)) s.push(profileName.textContent);
 save(); openProfile(profileName.textContent);
}

function openMessages(){main.style.display="none";messages.style.display="block";renderChats();}

function newChat(){let n=prompt("Имя чата");if(!n)return;
 DB.chats.push({name:n, msgs:[]}); save(); renderChats();}

function renderChats(){chatList.innerHTML="";
 DB.chats.forEach((c,i)=>{
  let d=document.createElement("div");d.className="card";
  d.innerHTML=`${c.name} <div class='btn' onclick='openChat(${i})'>Открыть</div>`;
  chatList.appendChild(d);
 });
}

function openChat(i){let c=DB.chats[i];
 chatWindow.innerHTML = `<h3>${c.name}</h3><div id='msgBox'></div>
 <input id='reply' class='input' placeholder='Сообщение'>
 <div class='btn' onclick='sendMsg(${i})'>Отправить</div>`;
 renderMsgs(i);
}

function renderMsgs(i){let box=document.getElementById("msgBox");box.innerHTML="";
 DB.chats[i].msgs.forEach((m,idx)=>{
  let d=document.createElement("div");d.className="card";
  d.innerHTML=`<b>${m.user}</b>: ${m.text}
  <div class='btn' onclick='replyTo(${i},${idx})'>Ответить</div>
  ${m.reply?`<div style='margin-left:20px;'>↳ <b>${m.reply.user}</b>: ${m.reply.text}</div>`:""}`;
  box.appendChild(d);
 });
}

function sendMsg(i){let t=reply.value.trim();if(!t)return;
 DB.chats[i].msgs.push({user:me,text:t}); save(); openChat(i);
}

function replyTo(i,m){let t=prompt("Ответ");if(!t)return;
 DB.chats[i].msgs[m].reply={user:me,text:t}; save(); openChat(i);
}
</script>

</body>
</html>
