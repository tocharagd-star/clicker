<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Y ‚Äî —Å–æ—Ü—Å–µ—Ç—å + TikHTML</title>
<style>
body {
    margin: 0;
    background: #0d0d0d;
    color: white;
    font-family: Arial;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
.fade { animation: fade .3s ease; }
@keyframes fade { from{opacity:0; transform:translateY(5px);} to{opacity:1;} }

/* –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é */
#topbar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 15px;
    background: #111;
    border-bottom: 1px solid #222;
    position: sticky;
    top: 0;
    z-index: 10;
}
#topbar button {
    width: auto;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    background: #1da1f2;
    color: white;
    cursor: pointer;
}

/* –ü–æ–ª—è */
input, textarea {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    border-radius: 10px;
    border: none;
    background: #1a1a1a;
    color: white;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.tweet, .project {
    background: #181818;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 12px;
    transition: .2s;
}
.tweet:hover, .project:hover { background:#202020; }

/* –†–µ–∞–∫—Ü–∏–∏ */
.reacts span {
    margin-right: 12px;
    cursor: pointer;
    font-size: 18px;
    transition: .15s;
}
.reacts span:hover { transform: scale(1.15); }

/* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
.avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background:#333;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    font-weight:bold;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.container { max-width: 600px; margin: 20px auto; padding: 10px; }

.hidden { display:none; }

/* TikHTML iframe */
iframe {
    width: 100%;
    height: 280px;
    border:none;
    background:white;
    border-radius:10px;
    margin-top:10px;
}

</style>
</head>
<body>

<!-- ========= –ú–ï–ù–Æ ========= -->
<div id="topbar" class="hidden">
    <button onclick="openFeed()">–õ–µ–Ω—Ç–∞</button>
    <button onclick="openCreate()">–°–æ–∑–¥–∞—Ç—å —Ç–≤–∏—Ç</button>
    <button onclick="openTikHTML()">TikHTML</button>
    <button onclick="openCreateTik()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
</div>

<!-- ========= –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ========= -->
<div id="register" class="container fade">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="regNick" placeholder="–ù–∏–∫">
    <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    <input id="regPass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å" type="password">
    <button onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    <button onclick="showLogin()">–£ –º–µ–Ω—è –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
</div>

<!-- ========= –í–•–û–î ========= -->
<div id="login" class="container hidden fade">
    <h2>–í—Ö–æ–¥</h2>
    <input id="logNick" placeholder="–ù–∏–∫">
    <input id="logPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <button onclick="showRegister()">–ù–∞–∑–∞–¥</button>
</div>

<!-- ========= –°–û–ó–î–ê–¢–¨ –¢–í–ò–¢ ========= -->
<div id="createTweet" class="container hidden fade">
    <h2>–°–æ–∑–¥–∞—Ç—å —Ç–≤–∏—Ç</h2>
    <textarea id="tweetText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
    <input id="tweetImg" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
    <button onclick="sendTweet()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<!-- ========= –õ–ï–ù–¢–ê ========= -->
<div id="feed" class="container hidden fade"></div>

<!-- ========= TikHTML ========= -->
<div id="tikhtml" class="container hidden fade"></div>

<!-- ========= –°–û–ó–î–ê–¢–¨ TikHTML ========= -->
<div id="createTik" class="container hidden fade">
    <h2>–ù–æ–≤—ã–π TikHTML –ø—Ä–æ–µ–∫—Ç</h2>
    <input id="tikName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
    <textarea id="tikCode" style="height:200px;" placeholder="HTML –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞"></textarea>
    <button onclick="saveTikHTML()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
</div>



<script>
/* ================= FIREBASE ================= */
const dbUrl = "https://aitube-8e681-default-rtdb.firebaseio.com/";

async function fb(path, method="GET", data=null) {
    let res = await fetch(dbUrl + path + ".json", {
        method,
        body: data ? JSON.stringify(data) : null
    });
    return await res.json();
}

/* ================= UI ================= */
const reg = document.getElementById("register");
const log = document.getElementById("login");
const feed = document.getElementById("feed");
const createT = document.getElementById("createTweet");
const tik = document.getElementById("tikhtml");
const createTik = document.getElementById("createTik");
const topbar = document.getElementById("topbar");

function showLogin(){ reg.classList.add("hidden"); log.classList.remove("hidden"); }
function showRegister(){ log.classList.add("hidden"); reg.classList.remove("hidden"); }

function openFeed(){ hideAll(); feed.classList.remove("hidden"); loadFeed(); }
function openCreate(){ hideAll(); createT.classList.remove("hidden"); }
function openTikHTML(){ hideAll(); tik.classList.remove("hidden"); loadTikHTML(); }
function openCreateTik(){ hideAll(); createTik.classList.remove("hidden"); }

function hideAll(){
    feed.classList.add("hidden");
    createT.classList.add("hidden");
    tik.classList.add("hidden");
    createTik.classList.add("hidden");
}

/* ================= –ê–í–ê–¢–ê–†–ö–ê (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) ================= */
function genAvatar(nick){
    let c = nick.charCodeAt(0);
    let hue = c * 12 % 360;
    return { bg:`hsl(${hue},70%,50%)`, letter: nick[0].toUpperCase() };
}

/* ================= –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ================= */
async function register(){
    let nick = regNick.value.trim();
    let pass = regPass.value;
    let pass2 = regPass2.value;

    if(!nick || !pass || pass!==pass2) return alert("–û—à–∏–±–∫–∞");

    let users = await fb("users");
    if(users && users[nick]) return alert("–ù–∏–∫ –∑–∞–Ω—è—Ç");

    await fb("users/"+nick, "PUT", {
        pass,
        react:{}
    });

    alert("–°–æ–∑–¥–∞–Ω–æ");
    showLogin();
}

/* ================= –ê–í–¢–û-–í–•–û–î ================= */
window.onload = async () => {
    if(localStorage.nick){
        let u = await fb("users/"+localStorage.nick);
        if(u){
            reg.classList.add("hidden");
            log.classList.add("hidden");
            topbar.classList.remove("hidden");
            openFeed();
        }
    }
};

/* ================= –í–•–û–î ================= */
async function login(){
    let nick = logNick.value.trim();
    let pass = logPass.value;

    let u = await fb("users/"+nick);
    if(!u || u.pass !== pass) return alert("–û—à–∏–±–∫–∞");

    localStorage.nick = nick;

    reg.classList.add("hidden");
    log.classList.add("hidden");
    topbar.classList.remove("hidden");
    openFeed();
}

/* ================= –¢–í–ò–¢–´ ================= */
async function sendTweet(){
    let text = tweetText.value.trim();
    let img = tweetImg.value.trim();
    let nick = localStorage.nick;

    if(!text && !img) return;

    await fb("tweets","POST",{
        nick,
        text,
        img,
        time: Date.now(),
        reactions: { like:0, laugh:0, wow:0 }
    });

    tweetText.value="";
    tweetImg.value="";
    openFeed();
}

/* ================= –†–ï–ê–ö–¶–ò–ò ================= */
async function react(id, type){
    let nick = localStorage.nick;
    let tweet = await fb("tweets/"+id);
    let user = await fb("users/"+nick);

    if(!tweet || !user) return;

    if(!user.react) user.react = {};

    let prev = user.react[id];

    if(prev===type){
        tweet.reactions[type]--;
        delete user.react[id];
    } else {
        if(prev) tweet.reactions[prev]--;
        tweet.reactions[type]++;
        user.react[id] = type;
    }

    await fb("tweets/"+id,"PUT",tweet);
    await fb("users/"+nick,"PUT",user);

    loadFeed();
}

/* ================= –õ–ï–ù–¢–ê ================= */
async function loadFeed(){
    feed.innerHTML = "";

    let tweets = await fb("tweets");
    if(!tweets) return;

    let arr = Object.entries(tweets).sort((a,b)=>b[1].time - a[1].time);

    for(let [id,t] of arr){
        let av = genAvatar(t.nick);
        feed.innerHTML += `
        <div class="tweet fade">
            <div style="display:flex;align-items:center;margin-bottom:8px;">
                <div class="avatar" style="background:${av.bg};">${av.letter}</div>
                <b style="margin-left:10px;">${t.nick}</b>
            </div>
            ${t.text? `<div>${t.text}</div>`:""}
            ${t.img? `<img src="${t.img}">`:""}
            <div class="reacts" style="margin-top:10px;">
                <span onclick="react('${id}','like')">‚ù§Ô∏è ${t.reactions.like}</span>
                <span onclick="react('${id}','laugh')">üòÇ ${t.reactions.laugh}</span>
                <span onclick="react('${id}','wow')">üòÆ ${t.reactions.wow}</span>
            </div>
        </div>`;
    }
}

/* ================= TikHTML ================= */
async function saveTikHTML(){
    let name = tikName.value.trim();
    let code = tikCode.value.trim();
    let nick = localStorage.nick;

    if(!name || !code) return;

    await fb("tikhtml","POST",{
        nick,
        name,
        code,
        time: Date.now()
    });

    tikName.value="";
    tikCode.value="";
    openTikHTML();
}

async function loadTikHTML(){
    tik.innerHTML = "";

    let projects = await fb("tikhtml");
    if(!projects) return;

    let arr = Object.entries(projects).sort((a,b)=>b[1].time - a[1].time);

    for(let [id,p] of arr){
        let av = genAvatar(p.nick);
        tik.innerHTML += `
        <div class="project fade">
            <div style="display:flex;align-items:center;margin-bottom:8px;">
                <div class="avatar" style="background:${av.bg};">${av.letter}</div>
                <b style="margin-left:10px;">${p.nick}</b>
            </div>
            <b>${p.name}</b>
            <iframe srcdoc="${encodeURIComponent(p.code)}"></iframe>
        </div>`;
    }
}
</script>
</body>
</html>
