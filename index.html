<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AiTube</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #000; color: #fff; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 24px; font-weight: bold; color: #f00; }
    .nav button { background: #333; color: #fff; border: none; padding: 8px 16px; margin-left: 10px; cursor: pointer; border-radius: 4px; }
    .nav button:hover { background: #555; }

    .auth-body { background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .auth-container { background: #222; padding: 30px; border-radius: 10px; width: 350px; text-align: center; }
    .auth-container input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; }
    .auth-container button { width: 100%; padding: 12px; background: #f00; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    .auth-container a { color: #0af; }

    .hidden { display: none; }

    .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .video-card { background: #111; border-radius: 10px; overflow: hidden; cursor: pointer; }
    .video-card video { width: 100%; height: 180px; object-fit: cover; }
    .video-info { padding: 12px; }
    .video-title { font-weight: bold; margin-bottom: 5px; }
    .video-channel { font-size: 14px; color: #aaa; }
    .video-actions { display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px; }
    .video-actions button { background: none; border: none; color: #aaa; cursor: pointer; }
    .video-actions button.liked { color: #0af; }
    .video-actions button.disliked { color: #f55; }

    .comments { margin-top: 10px; }
    .comment { background: #222; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 14px; }
    .comment-input { display: flex; margin-top: 10px; }
    .comment-input input { flex: 1; padding: 10px; border: none; border-radius: 5px 0 0 5px; }
    .comment-input button { padding: 10px 15px; background: #f00; color: #fff; border: none; border-radius: 0 5px 5px 0; cursor: pointer; }

    .profile-info { text-align: center; margin-bottom: 30px; }
    .profile-info img { width: 100px; height: 100px; border-radius: 50%; background: #333; margin-bottom: 10px; }
    .subscribe-btn { background: #f00; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
    .subscribed { background: #333; }

    .upload-form { background: #111; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .upload-form input, .upload-form textarea { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; }
    .upload-form button { background: #f00; color: #fff; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; }
    progress { width: 100%; height: 10px; margin-top: 10px; }

    @media (max-width: 768px) {
      .video-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- АВТОРИЗАЦИЯ -->
  <div id="authSection" class="auth-body">
    <div class="auth-container">
      <h2 id="authTitle">Вход</h2>
      <input type="email" id="authEmail" placeholder="Email" />
      <input type="password" id="authPassword" placeholder="Пароль" />
      <input type="text" id="authUsername" placeholder="Имя пользователя" class="hidden" />
      <button id="authBtn">Войти</button>
      <p id="authToggle">Нет аккаунта? <a href="#" id="toggleLink">Зарегистрироваться</a></p>
    </div>
  </div>

  <!-- ГЛАВНАЯ -->
  <div id="mainApp" class="hidden">
    <header>
      <div class="logo">AiTube</div>
      <div class="nav">
        <button id="uploadNavBtn" class="btn">Загрузить</button>
        <button id="profileNavBtn" class="btn">Профиль</button>
        <button id="logoutBtn" class="btn">Выйти</button>
      </div>
    </header>

    <div class="container">
      <!-- Загрузка видео -->
      <div id="uploadSection" class="upload-form hidden">
        <h2>Загрузить видео</h2>
        <input type="text" id="videoTitle" placeholder="Название видео" />
        <textarea id="videoDesc" placeholder="Описание"></textarea>
        <input type="file" id="videoFile" accept="video/*" />
        <button id="uploadVideoBtn">Загрузить</button>
        <progress id="uploadProgress" value="0" max="100"></progress>
      </div>

      <!-- Главная страница -->
      <div id="homeSection">
        <div id="videoGrid" class="video-grid"></div>
      </div>

      <!-- Профиль -->
      <div id="profileSection" class="hidden">
        <div id="profileInfo" class="profile-info"></div>
        <h3>Мои видео</h3>
        <div id="myVideos" class="video-grid"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script type="module">
    // === КОНФИГУРАЦИЯ FIREBASE ===
    const firebaseConfig = {
      databaseURL: "https://aitube-8e681-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let currentVideoId = null;

    // === ЭЛЕМЕНТЫ ===
    const authSection = document.getElementById('authSection');
    const mainApp = document.getElementById('mainApp');
    const authTitle = document.getElementById('authTitle');
    const authBtn = document.getElementById('authBtn');
    const authToggle = document.getElementById('authToggle');
    const toggleLink = document.getElementById('toggleLink');
    const authUsername = document.getElementById('authUsername');

    const homeSection = document.getElementById('homeSection');
    const profileSection = document.getElementById('profileSection');
    const uploadSection = document.getElementById('uploadSection');

    const uploadNavBtn = document.getElementById('uploadNavBtn');
    const profileNavBtn = document.getElementById('profileNavBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // === ПЕРЕКЛЮЧЕНИЕ АВТОРИЗАЦИИ ===
    let isLogin = true;
    toggleLink.onclick = (e) => {
      e.preventDefault();
      isLogin = !isLogin;
      authTitle.textContent = isLogin ? 'Вход' : 'Регистрация';
      authBtn.textContent = isLogin ? 'Войти' : 'Зарегистрироваться';
      authToggle.innerHTML = isLogin 
        ? 'Нет аккаунта? <a href="#" id="toggleLink">Зарегистрироваться</a>' 
        : 'Уже есть аккаунт? <a href="#" id="toggleLink">Войти</a>';
      authUsername.classList.toggle('hidden');
      document.getElementById('toggleLink').onclick = arguments.c[0];
    };

    // === АВТОРИЗАЦИЯ ===
    authBtn.onclick = () => {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const username = document.getElementById('authUsername').value;

      if (isLogin) {
        auth.signInWithEmailAndPassword(email, password)
          .then(cred => loadUser(cred.user))
          .catch(err => alert(err.message));
      } else {
        if (!username) return alert("Введите имя пользователя");
        auth.createUserWithEmailAndPassword(email, password)
          .then(cred => {
            return db.ref('users/' + cred.user.uid).set({
              username, email, subscribers: 0, subscribedTo: {}
            }).then(() => loadUser(cred.user));
          })
          .catch(err => alert(err.message));
      }
    };

    // === ВЫХОД ===
    logoutBtn.onclick = () => {
      auth.signOut().then(() => {
        currentUser = null;
        mainApp.classList.add('hidden');
        authSection.classList.remove('hidden');
      });
    };

    // === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЯ ===
    function loadUser(user) {
      currentUser = user;
      db.ref('users/' + user.uid).once('value').then(snap => {
        const data = snap.val();
        if (data) currentUser.username = data.username;
        authSection.classList.add('hidden');
        mainApp.classList.remove('hidden');
        showHome();
        loadVideos();
      });
    }

    // === НАВИГАЦИЯ ===
    uploadNavBtn.onclick = () => {
      homeSection.classList.add('hidden');
      profileSection.classList.add('hidden');
      uploadSection.classList.remove('hidden');
    };

    profileNavBtn.onclick = () => {
      homeSection.classList.add('hidden');
      uploadSection.classList.add('hidden');
      profileSection.classList.remove('hidden');
      loadProfile();
    };

    function showHome() {
      uploadSection.classList.add('hidden');
      profileSection.classList.add('hidden');
      homeSection.classList.remove('hidden');
      loadVideos();
    }

    // === ЗАГРУЗКА ВИДЕО ===
    document.getElementById('uploadVideoBtn').onclick = () => {
      const file = document.getElementById('videoFile').files[0];
      const title = document.getElementById('videoTitle').value;
      const desc = document.getElementById('videoDesc').value;
      if (!file || !title) return alert("Заполните поля");

      const reader = new FileReader();
      reader.onload = (e) => {
        const videoId = Date.now() + Math.random().toString(36);
        const videoData = {
          id: videoId,
          title, desc,
          url: e.target.result,
          authorId: currentUser.uid,
          author: currentUser.username,
          timestamp: Date.now(),
          likes: 0, dislikes: 0, views: 0,
          likedBy: {}, dislikedBy: {}, comments: []
        };

        db.ref('videos/' + videoId).set(videoData).then(() => {
          alert("Видео загружено!");
          document.getElementById('videoFile').value = '';
          document.getElementById('videoTitle').value = '';
          document.getElementById('videoDesc').value = '';
          showHome();
        });
      };
      reader.readAsDataURL(file);
    };

    // === ОТОБРАЖЕНИЕ ВИДЕО ===
    function loadVideos() {
      const grid = document.getElementById('videoGrid');
      grid.innerHTML = '<p>Загрузка...</p>';
      db.ref('videos').on('value', snap => {
        const videos = snap.val() || {};
        grid.innerHTML = '';
        Object.values(videos).sort((a,b) => b.timestamp - a.timestamp).forEach(video => {
          const card = createVideoCard(video);
          grid.appendChild(card);
        });
      });
    }

    function createVideoCard(video) {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.onclick = () => openVideoModal(video);

      const liked = video.likedBy?.[currentUser?.uid];
      const disliked = video.dislikedBy?.[currentUser?.uid];

      card.innerHTML = `
        <video src="${video.url}" preload="metadata"></video>
        <div class="video-info">
          <div class="video-title">${video.title}</div>
          <div class="video-channel">${video.author}</div>
          <div class="video-actions">
            <button class="like-btn ${liked ? 'liked' : ''}"><i class="fas fa-thumbs-up"></i> ${video.likes || 0}</button>
            <button class="dislike-btn ${disliked ? 'disliked' : ''}"><i class="fas fa-thumbs-down"></i> ${video.dislikes || 0}</button>
            <span><i class="fas fa-eye"></i> ${video.views || 0}</span>
          </div>
        </div>
      `;

      // Лайки/дизлайки
      card.querySelector('.like-btn').onclick = (e) => {
        e.stopPropagation();
        toggleLike(video.id, !liked);
      };
      card.querySelector('.dislike-btn').onclick = (e) => {
        e.stopPropagation();
        toggleLike(video.id, false, !disliked);
      };

      return card;
    }

    // === МОДАЛЬНОЕ ОКНО ВИДЕО ===
    function openVideoModal(video) {
      currentVideoId = video.id;
      db.ref('videos/' + video.id + '/views').transaction(v => (v || 0) + 1);

      const modal = document.createElement('div');
      modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px;`;
      modal.innerHTML = `
        <div style="background:#111;border-radius:10px;max-width:900px;width:100%;max-height:90vh;overflow:auto;">
          <div style="padding:20px;">
            <button style="float:right;background:none;border:none;color:#fff;font-size:20px;cursor:pointer;" onclick="this.closest('[style]').remove()">×</button>
            <h2>${video.title}</h2>
            <video controls src="${video.url}" style="width:100%;max-height:500px;"></video>
            <p>${video.desc}</p>
            <div style="margin:15px 0;display:flex;justify-content:space-between;align-items:center;">
              <span>Автор: <strong>${video.author}</strong></span>
              <button id="subscribeBtn" class="subscribe-btn">Подписаться</button>
            </div>
            <div class="comments" id="commentsList"></div>
            <div class="comment-input">
              <input type="text" id="commentInput" placeholder="Напишите комментарий..." />
              <button id="sendComment">Отправить</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      loadComments(video.id);
      checkSubscription(video.authorId, modal.querySelector('#subscribeBtn'));

      modal.querySelector('#sendComment').onclick = () => {
        const input = modal.querySelector('#commentInput');
        if (!input.value.trim()) return;
        const comment = {
          text: input.value,
          author: currentUser.username,
          authorId: currentUser.uid,
          timestamp: Date.now()
        };
        db.ref('videos/' + video.id + '/comments').push(comment).then(() => {
          input.value = '';
        });
      };
    }

    function loadComments(videoId) {
      const list = document.getElementById('commentsList');
      if (!list) return;
      db.ref('videos/' + videoId + '/comments').on('value', snap => {
        const comments = snap.val() || {};
        list.innerHTML = Object.values(comments).sort((a,b) => a.timestamp - b.timestamp).map(c => `
          <div class="comment">
            <strong>${c.author}</strong>: ${c.text}
            <small style="float:right;color:#aaa;">${new Date(c.timestamp).toLocaleString()}</small>
          </div>
        `).join('');
      });
    }

    // === ЛАЙКИ ===
    function toggleLike(videoId, isLike, isDislike = false) {
      if (!currentUser) return;
      const path = `videos/${videoId}/${isLike ? 'likedBy' : 'dislikedBy'}/${currentUser.uid}`;
      const opposite = isLike ? 'dislikedBy' : 'likedBy';
      db.ref(`videos/${videoId}/${opposite}/${currentUser.uid}`).remove();
      db.ref(path).set(true).then(() => {
        const inc = isLike ? { likes: firebase.database.ServerValue.increment(1) } 
                          : { dislikes: firebase.database.ServerValue.increment(1) };
        db.ref('videos/' + videoId).update(inc);
      });
    }

    // === ПОДПИСКИ ===
    function checkSubscription(authorId, btn) {
      if (!currentUser || authorId === currentUser.uid) {
        btn.style.display = 'none';
        return;
      }
      db.ref('users/' + currentUser.uid + '/subscribedTo/' + authorId).once('value').then(snap => {
        if (snap.val()) {
          btn.textContent = 'Отписаться';
          btn.classList.add('subscribed');
        } else {
          btn.textContent = 'Подписаться';
          btn.classList.remove('subscribed');
        }
        btn.onclick = () => toggleSubscribe(authorId, btn);
      });
    }

    function toggleSubscribe(authorId, btn) {
      const path = 'users/' + currentUser.uid + '/subscribedTo/' + authorId;
      db.ref(path).once('value').then(snap => {
        if (snap.val()) {
          db.ref(path).remove();
          db.ref('users/' + authorId + '/subscribers').transaction(v => (v || 1) - 1);
          btn.textContent = 'Подписаться';
          btn.classList.remove('subscribed');
        } else {
          db.ref(path).set(true);
          db.ref('users/' + authorId + '/subscribers').transaction(v => (v || 0) + 1);
          btn.textContent = 'Отписаться';
          btn.classList.add('subscribed');
        }
      });
    }

    // === ПРОФИЛЬ ===
    function loadProfile() {
      db.ref('users/' + currentUser.uid).once('value').then(snap => {
        const user = snap.val();
        document.getElementById('profileInfo').innerHTML = `
          <img src="https://via.placeholder.com/100" />
          <h2>${user.username}</h2>
          <p>${user.email}</p>
          <p>Подписчиков: <strong>${user.subscribers || 0}</strong></p>
        `;
      });

      const grid = document.getElementById('myVideos');
      grid.innerHTML = '<p>Загрузка...</p>';
      db.ref('videos').on('value', snap => {
        const videos = snap.val() || {};
        grid.innerHTML = '';
        Object.values(videos).filter(v => v.authorId === currentUser.uid).forEach(video => {
          grid.appendChild(createVideoCard(video));
        });
      });
    }

    // Авто-вход
    auth.onAuthStateChanged(user => {
      if (user && !currentUser) {
        loadUser(user);
      }
    });
  </script>
</body>
</html>
