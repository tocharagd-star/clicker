<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AiTube</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #000; color: #fff; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 24px; font-weight: bold; color: #f00; }
    .nav button { background: #333; color: #fff; border: none; padding: 8px 16px; margin-left: 10px; cursor: pointer; border-radius: 4px; }
    .nav button:hover { background: #555; }

    .auth-body { background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .auth-container { background: #222; padding: 40px; border-radius: 15px; width: 380px; text-align: center; box-shadow: 0 0 20px rgba(255,0,0,0.3); }
    .auth-container h1 { margin-bottom: 20px; font-size: 28px; }
    .auth-container input { width: 100%; padding: 14px; margin: 12px 0; border: none; border-radius: 8px; font-size: 16px; }
    .auth-container button { width: 100%; padding: 14px; background: #f00; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 10px; }
    .auth-container button:hover { background: #c00; }
    .error { color: #f55; margin-top: 10px; padding: 10px; background: #300; border-radius: 5px; }

    .hidden { display: none; }

    .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .video-card { background: #111; border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
    .video-card:hover { transform: scale(1.03); }
    .video-card video { width: 100%; height: 180px; object-fit: cover; background: #000; }
    .video-info { padding: 12px; }
    .video-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; }
    .video-channel { font-size: 14px; color: #aaa; margin-bottom: 8px; }
    .video-actions { display: flex; justify-content: space-between; font-size: 14px; }
    .video-actions button { background: none; border: none; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .video-actions button.liked { color: #0af; }
    .video-actions button.disliked { color: #f55; }

    .comments { margin-top: 15px; }
    .comment { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }
    .comment-input { display: flex; margin-top: 10px; }
    .comment-input input { flex: 1; padding: 10px; border: none; border-radius: 5px 0 0 5px; }
    .comment-input button { padding: 10px 15px; background: #f00; color: #fff; border: none; border-radius: 0 5px 5px 0; cursor: pointer; }

    .profile-info { text-align: center; margin-bottom: 30px; }
    .profile-info img { width: 100px; height: 100px; border-radius: 50%; background: #333; margin-bottom: 10px; }
    .subscribe-btn { background: #f00; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; }
    .subscribed { background: #333; }

    .upload-form { background: #111; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .upload-form input, .upload-form textarea { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; }
    .upload-form button { background: #f00; color: #fff; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; }
    progress { width: 100%; height: 10px; margin-top: 10px; }

    @media (max-width: 768px) {
      .video-grid { grid-template-columns: 1fr; }
      .auth-container { width: 90%; }
    }
  </style>
</head>
<body>

  <!-- ПРОСТАЯ РЕГИСТРАЦИЯ -->
  <div id="authSection" class="auth-body">
    <div class="auth-container">
      <h1>AiTube</h1>
      <p style="margin-bottom: 20px; color: #aaa;">Введи своё имя и начни!</p>
      <input type="text" id="usernameInput" placeholder="Твоё имя" maxlength="20" />
      <button id="startBtn">Начать смотреть</button>
      <div id="errorMsg" class="error hidden"></div>
    </div>
  </div>

  <!-- ГЛАВНОЕ ПРИЛОЖЕНИЕ -->
  <div id="mainApp" class="hidden">
    <header>
      <div class="logo">AiTube</div>
      <div class="nav">
        <button id="uploadNavBtn" class="btn">Загрузить</button>
        <button id="profileNavBtn" class="btn">Профиль</button>
        <button id="logoutBtn" class="btn">Сменить имя</button>
      </div>
    </header>

    <div class="container">
      <!-- Загрузка -->
      <div id="uploadSection" class="upload-form hidden">
        <h2>Загрузить видео</h2>
        <input type="text" id="videoTitle" placeholder="Название видео" />
        <textarea id="videoDesc" placeholder="Описание (необязательно)"></textarea>
        <input type="file" id="videoFile" accept="video/*" />
        <button id="uploadVideoBtn">Загрузить</button>
        <progress id="uploadProgress" value="0" max="100" class="hidden"></progress>
        <div id="uploadError" class="error hidden"></div>
      </div>

      <!-- Главная -->
      <div id="homeSection">
        <div id="videoGrid" class="video-grid"></div>
      </div>

      <!-- Профиль -->
      <div id="profileSection" class="hidden">
        <div class="profile-info">
          <img src="https://via.placeholder.com/100/333/fff?text=User" />
          <h2 id="profileName"></h2>
          <p>Подписчиков: <strong id="subCount">0</strong></p>
        </div>
        <h3>Мои видео</h3>
        <div id="myVideos" class="video-grid"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script type="module">
    console.log("=== AiTube: Запуск ===");
    
    // === КОНФИГ FIREBASE ===
    const firebaseConfig = {
      databaseURL: "https://aitube-8e681-default-rtdb.firebaseio.com/"
    };

    let app, db, auth;
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database(app);
      auth = firebase.auth(app);
      console.log("Firebase: Инициализация OK");
      
      // Тест базы
      db.ref('.info/connected').on('value', (snap) => {
        if (snap.val() === true) {
          console.log("Firebase: Соединение с базой OK");
        } else {
          console.error("Firebase: Нет соединения с базой!");
        }
      });
    } catch (error) {
      console.error("Firebase: Ошибка init", error);
      alert("Ошибка Firebase: " + error.message + ". Проверь config!");
      throw error;
    }

    let currentUser = null;

    // Элементы
    const authSection = document.getElementById('authSection');
    const mainApp = document.getElementById('mainApp');
    const usernameInput = document.getElementById('usernameInput');
    const startBtn = document.getElementById('startBtn');
    const errorMsg = document.getElementById('errorMsg');
    const uploadNavBtn = document.getElementById('uploadNavBtn');
    const profileNavBtn = document.getElementById('profileNavBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const homeSection = document.getElementById('homeSection');
    const uploadSection = document.getElementById('uploadSection');
    const profileSection = document.getElementById('profileSection');
    const uploadError = document.getElementById('uploadError');

    // Показ ошибки
    function showError(el, msg) {
      console.error("Ошибка:", msg);
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    // === ПРОСТАЯ АВТОРИЗАЦИЯ ===
    startBtn.onclick = () => {
      const name = usernameInput.value.trim();
      if (!name || name.length < 2) {
        showError(errorMsg, "Имя слишком короткое (минимум 2 символа)");
        return;
      }

      console.log("Авторизация анонимно для:", name);
      auth.signInAnonymously()
        .then(cred => {
          console.log("Auth OK, UID:", cred.user.uid);
          currentUser = cred.user;
          return db.ref('users/' + currentUser.uid).set({
            username: name,
            subscribers: 0,
            subscribedTo: {}
          });
        })
        .then(() => {
          console.log("Пользователь сохранён в БД");
          currentUser.username = name;
          authSection.classList.add('hidden');
          mainApp.classList.remove('hidden');
          showHome();
          loadVideos();
        })
        .catch(err => {
          console.error("Auth/DB ошибка:", err.code, err.message);
          showError(errorMsg, "Ошибка входа (" + err.code + "): " + err.message + ". Проверь Anonymous в Firebase Auth!");
        });
    };

    // Смена имени
    logoutBtn.onclick = () => {
      if (confirm("Сменить имя? Данные сохранятся.")) {
        console.log("Выход");
        auth.signOut().then(() => {
          currentUser = null;
          mainApp.classList.add('hidden');
          authSection.classList.remove('hidden');
          usernameInput.value = '';
          errorMsg.classList.add('hidden');
        });
      }
    };

    // Навигация
    uploadNavBtn.onclick = () => {
      homeSection.classList.add('hidden');
      profileSection.classList.add('hidden');
      uploadSection.classList.remove('hidden');
    };

    profileNavBtn.onclick = () => {
      homeSection.classList.add('hidden');
      uploadSection.classList.add('hidden');
      profileSection.classList.remove('hidden');
      loadProfile();
    };

    function showHome() {
      uploadSection.classList.add('hidden');
      profileSection.classList.add('hidden');
      homeSection.classList.remove('hidden');
      loadVideos();
    }

    // === ЗАГРУЗКА ВИДЕО ===
    document.getElementById('uploadVideoBtn').onclick = () => {
      const file = document.getElementById('videoFile').files[0];
      const title = document.getElementById('videoTitle').value.trim();
      if (!file || !title) return showError(uploadError, "Выбери видео и введи название");

      if (file.size > 10 * 1024 * 1024) return showError(uploadError, "Видео >10MB. Используй маленькое!");

      const progress = document.getElementById('uploadProgress');
      progress.classList.remove('hidden');
      const reader = new FileReader();
      reader.onload = (e) => {
        const videoId = Date.now() + "_" + Math.random().toString(36).substr(2, 5);
        const videoData = {
          id: videoId,
          title,
          desc: document.getElementById('videoDesc').value,
          url: e.target.result,
          authorId: currentUser.uid,
          author: currentUser.username,
          timestamp: Date.now(),
          likes: 0, dislikes: 0, views: 0,
          likedBy: {}, dislikedBy: {}, comments: {}
        };

        console.log("Загрузка видео в БД:", videoId);
        db.ref('videos/' + videoId).set(videoData)
          .then(() => {
            console.log("Видео сохранено");
            alert("Видео загружено!");
            document.getElementById('videoFile').value = '';
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDesc').value = '';
            progress.classList.add('hidden');
            showHome();
          })
          .catch(err => {
            console.error("Upload ошибка:", err);
            showError(uploadError, "Ошибка загрузки (" + err.code + "): " + err.message);
          });
      };
      reader.onprogress = (e) => {
        if (e.lengthComputable) progress.value = (e.loaded / e.total) * 100;
      };
      reader.onerror = () => showError(uploadError, "Ошибка чтения файла");
      reader.readAsDataURL(file);
    };

    // === ВИДЕО ===
    function loadVideos() {
      const grid = document.getElementById('videoGrid');
      grid.innerHTML = '<p style="text-align:center; color:#aaa;">Загрузка...</p>';
      console.log("Загрузка видео из БД");
      db.ref('videos').once('value').then(snap => {
        const videos = snap.val() || {};
        console.log("Видео загружено:", Object.keys(videos).length);
        grid.innerHTML = '';
        if (Object.keys(videos).length === 0) {
          grid.innerHTML = '<p style="text-align:center; color:#aaa;">Нет видео. Будь первым!</p>';
          return;
        }
        Object.values(videos).sort((a,b) => b.timestamp - a.timestamp).forEach(video => {
          grid.appendChild(createVideoCard(video));
        });
      }).catch(err => {
        console.error("Load видео ошибка:", err);
        grid.innerHTML = '<p style="text-align:center; color:#f55;">Ошибка загрузки: ' + err.message + '</p>';
      });
    }

    function createVideoCard(video) {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.onclick = () => openVideoModal(video);

      const liked = video.likedBy?.[currentUser?.uid];
      const disliked = video.dislikedBy?.[currentUser?.uid];

      card.innerHTML = `
        <video src="${video.url}" preload="metadata"></video>
        <div class="video-info">
          <div class="video-title">${video.title}</div>
          <div class="video-channel">${video.author}</div>
          <div class="video-actions">
            <button class="like-btn ${liked ? 'liked' : ''}"><i class="fas fa-thumbs-up"></i> ${video.likes || 0}</button>
            <button class="dislike-btn ${disliked ? 'disliked' : ''}"><i class="fas fa-thumbs-down"></i> ${video.dislikes || 0}</button>
            <span><i class="fas fa-eye"></i> ${video.views || 0}</span>
          </div>
        </div>
      `;

      card.querySelector('.like-btn').onclick = (e) => { e.stopPropagation(); toggleLike(video.id, true); };
      card.querySelector('.dislike-btn').onclick = (e) => { e.stopPropagation(); toggleLike(video.id, false); };

      return card;
    }

    function openVideoModal(video) {
      db.ref('videos/' + video.id + '/views').transaction(v => (v || 0) + 1);

      const modal = document.createElement('div');
      modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px;`;
      modal.innerHTML = `
        <div style="background:#111;border-radius:15px;max-width:900px;width:100%;max-height:90vh;overflow:auto;padding:20px;">
          <button style="float:right;background:none;border:none;color:#fff;font-size:24px;cursor:pointer;" onclick="this.closest('[style]').remove()">×</button>
          <h2 style="margin-bottom:10px;">${video.title}</h2>
          <video controls src="${video.url}" style="width:100%;max-height:500px;border-radius:8px;"></video>
          <p style="margin:15px 0; color:#ccc;">${video.desc || ''}</p>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span><strong>${video.author}</strong> • ${video.views || 0} просмотров</span>
            <button id="subBtn" class="subscribe-btn" style="display:${video.authorId !== currentUser.uid ? 'inline' : 'none'};">Подписаться</button>
          </div>
          <div id="commentsList" class="comments"></div>
          <div class="comment-input">
            <input type="text" id="commentInput" placeholder="Комментарий..." />
            <button id="sendComment">Отправить</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      loadComments(video.id);
      if (video.authorId !== currentUser.uid) checkSubscription(video.authorId, modal.querySelector('#subBtn'));

      modal.querySelector('#sendComment').onclick = () => {
        const input = modal.querySelector('#commentInput');
        const text = input.value.trim();
        if (!text) return;
        const cid = Date.now().toString();
        db.ref(`videos/${video.id}/comments/${cid}`).set({
          text, author: currentUser.username, authorId: currentUser.uid, timestamp: Date.now()
        }).then(() => input.value = '').catch(err => alert("Ошибка коммента: " + err.message));
      };
    }

    function loadComments(vid) {
      const list = document.getElementById('commentsList');
      db.ref(`videos/${vid}/comments`).on('value', snap => {
        const coms = snap.val() || {};
        list.innerHTML = Object.values(coms).sort((a,b) => a.timestamp - b.timestamp).map(c => `
          <div class="comment"><strong>${c.author}</strong>: ${c.text}</div>
        `).join('') || '<p style="color:#aaa;">Нет комментариев</p>';
      });
    }

    function toggleLike(vid, isLike) {
      const path = `videos/${vid}/${isLike ? 'likedBy' : 'dislikedBy'}/${currentUser.uid}`;
      const opp = isLike ? 'dislikedBy' : 'likedBy';
      db.ref(`videos/${vid}/${opp}/${currentUser.uid}`).remove();
      db.ref(path).once('value').then(snap => {
        if (snap.val()) {
          db.ref(path).remove();
          db.ref(`videos/${vid}/${isLike ? 'likes' : 'dislikes'}`).transaction(v => Math.max((v || 0) - 1, 0));
        } else {
          db.ref(path).set(true);
          db.ref(`videos/${vid}/${isLike ? 'likes' : 'dislikes'}`).transaction(v => (v || 0) + 1);
        }
        loadVideos();
      });
    }

    function checkSubscription(aid, btn) {
      db.ref(`users/${currentUser.uid}/subscribedTo/${aid}`).once('value').then(snap => {
        const sub = snap.val();
        btn.textContent = sub ? 'Отписаться' : 'Подписаться';
        btn.classList.toggle('subscribed', sub);
        btn.onclick = () => toggleSub(aid, btn);
      });
    }

    function toggleSub(aid, btn) {
      const path = `users/${currentUser.uid}/subscribedTo/${aid}`;
      db.ref(path).once('value').then(snap => {
        if (snap.val()) {
          db.ref(path).remove();
          db.ref(`users/${aid}/subscribers`).transaction(v => Math.max((v || 0) - 1, 0));
        } else {
          db.ref(path).set(true);
          db.ref(`users/${aid}/subscribers`).transaction(v => (v || 0) + 1);
        }
        checkSubscription(aid, btn);
      });
    }

    function loadProfile() {
      db.ref('users/' + currentUser.uid).once('value').then(snap => {
        const u = snap.val();
        document.getElementById('profileName').textContent = u.username;
        document.getElementById('subCount').textContent = u.subscribers || 0;
      }).catch(err => console.error("Profile ошибка:", err));

      const grid = document.getElementById('myVideos');
      grid.innerHTML = '<p style="text-align:center; color:#aaa;">Загрузка...</p>';
      db.ref('videos').once('value').then(snap => {
        const vids = snap.val() || {};
        grid.innerHTML = '';
        const mine = Object.values(vids).filter(v => v.authorId === currentUser.uid);
        if (mine.length === 0) {
          grid.innerHTML = '<p style="text-align:center; color:#aaa;">Нет видео</p>';
        } else {
          mine.forEach(v => grid.appendChild(createVideoCard(v)));
        }
      });
    }

    // Авто-вход
    auth.onAuthStateChanged(user => {
      if (user && !currentUser) {
        console.log("Авто-вход, UID:", user.uid);
        currentUser = user;
        db.ref('users/' + user.uid).once('value').then(snap => {
          const data = snap.val();
          if (data) {
            currentUser.username = data.username;
            authSection.classList.add('hidden');
            mainApp.classList.remove('hidden');
            showHome();
            loadVideos();
          } else {
            console.log("Нет данных пользователя — выход");
            auth.signOut();
          }
        });
      }
    });

    console.log("=== AiTube: Готово ===");
  </script>
</body>
</html>
