<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Advanced Clicker</title>
<style>
body { background:#1e1e2f; color:#fff; font-family:sans-serif; display:flex; justify-content:center; align-items:flex-start; padding:20px; }
.container { width:400px; background:#2a2a3f; padding:20px; border-radius:12px; margin-right:20px; }
button, input, select { width:100%; padding:10px; margin:5px 0; border:none; border-radius:6px; font-size:16px; }
button { background:#4e4eff; color:#fff; cursor:pointer; }
button:hover { background:#6f6fff; }
#score { font-size:32px; text-align:center; margin:10px 0; }
.list { max-height:150px; overflow-y:auto; border:1px solid #555; border-radius:6px; padding:5px; margin-bottom:10px; }
.item { padding:5px; border-bottom:1px solid #444; display:flex; align-items:center; }
.item img { width:24px; height:24px; border-radius:50%; margin-right:8px; }
.hidden { display:none; }
#menu button { width:32%; display:inline-block; margin:5px 1%; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- Login Screen -->
<div class="container" id="loginScreen">
<h1>Вход / Регистрация</h1>
<input type="text" id="nickname" placeholder="Введите ник">
<button id="registerBtn">Зарегистрироваться</button>
<button id="googleLogin">Войти через Google</button>
</div>

<!-- Game Screen -->
<div class="container hidden" id="gameScreen">
<h2 id="welcome"></h2>
<div id="score">0</div>

<div id="menu">
<button id="clickBtn">Клик!</button>
<button id="upgradeBtn">Апгрейды</button>
<button id="profileBtn">Профиль</button>
</div>

<!-- Panels -->
<div id="upgradesPanel" class="hidden">
<h3>Апгрейды</h3>
<button id="autoClickBtn">Автоклик (+1/сек) — 50 очков</button>
<button id="bonusClickBtn">Бонус клик (+1 клик/клик) — 100 очков</button>
</div>

<div id="profilePanel" class="hidden">
<h3>Кастомизация профиля</h3>
<input type="text" id="customNick" placeholder="Новый ник">
<select id="colorSelect">
<option value="#fff">Белый</option>
<option value="#ff0">Жёлтый</option>
<option value="#0f0">Зелёный</option>
<option value="#0ff">Голубой</option>
<option value="#f0f">Фиолетовый</option>
</select>
<button id="saveProfileBtn">Сохранить</button>
</div>

<h3>Игроки онлайн</h3>
<div class="list" id="online"></div>

<h3>Лидерборд</h3>
<div class="list" id="leaders"></div>
</div>

<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyB7d3kYeYEcTUy8tz-hKbYMw5f5zbRH6Ug",
  authDomain: "clicker-3044c.firebaseapp.com",
  databaseURL: "https://clicker-3044c-default-rtdb.firebaseio.com",
  projectId: "clicker-3044c",
  storageBucket: "clicker-3044c.firebasestorage.app",
  messagingSenderId: "143909161656",
  appId: "1:143909161656:web:368498af1ab183e56d024d",
  measurementId: "G-JWS932SQBG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ---------------- State ----------------
let user = null;
let photo = null;
let score = 0;
let autoClick = false;
let bonusPerClick = 1;

// ---------------- Check saved account ----------------
if(localStorage.getItem("clickerUser")) {
    const saved = JSON.parse(localStorage.getItem("clickerUser"));
    user = saved.user;
    photo = saved.photo;
    score = saved.score || 0;
    showGameScreen();
}

// ---------------- Functions ----------------
function showGameScreen() {
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("gameScreen").classList.remove("hidden");
    document.getElementById("welcome").innerText = "Игрок: " + user;
    document.getElementById("score").innerText = score;
    appearOnline();
    listenOnline();
    listenLeaderboard();
}

// ---------------- Registration ----------------
document.getElementById("registerBtn").addEventListener("click",()=>{
    let nick = document.getElementById("nickname").value.trim();
    if(!nick) nick = "Игрок"+Math.floor(Math.random()*1000);
    user = nick;
    photo = null;
    score = 0;
    localStorage.setItem("clickerUser", JSON.stringify({user, photo, score}));
    db.ref("users/"+user).set({score, photo});
    showGameScreen();
});

// ---------------- Google Login ----------------
document.getElementById("googleLogin").addEventListener("click", ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(result=>{
        user = result.user.displayName || "Игрок"+Math.floor(Math.random()*1000);
        photo = result.user.photoURL;
        score = 0;
        localStorage.setItem("clickerUser", JSON.stringify({user, photo, score}));
        db.ref("users/"+user).set({score, photo});
        showGameScreen();
    }).catch(err=>alert("Ошибка Google: "+err.message));
});

// ---------------- Click ----------------
document.getElementById("clickBtn").addEventListener("click",()=>{
    if(!user) return;
    score += bonusPerClick;
    document.getElementById("score").innerText = score;
    saveScore();
});

// ---------------- Save Score ----------------
function saveScore(){
    db.ref("users/"+user).set({score, photo});
    localStorage.setItem("clickerUser", JSON.stringify({user, photo, score}));
}

// ---------------- Menu ----------------
document.getElementById("upgradeBtn").addEventListener("click",()=>{
    document.getElementById("upgradesPanel").classList.toggle("hidden");
    document.getElementById("profilePanel").classList.add("hidden");
});
document.getElementById("profileBtn").addEventListener("click",()=>{
    document.getElementById("profilePanel").classList.toggle("hidden");
    document.getElementById("upgradesPanel").classList.add("hidden");
});

// ---------------- Upgrades ----------------
document.getElementById("autoClickBtn").addEventListener("click",()=>{
    if(score>=50){ score-=50; autoClick=true; startAutoClick(); saveScore(); }
});
document.getElementById("bonusClickBtn").addEventListener("click",()=>{
    if(score>=100){ score-=100; bonusPerClick++; saveScore(); }
});
function startAutoClick(){
    setInterval(()=>{ if(autoClick){ score+=1; document.getElementById("score").innerText=score; saveScore(); } },1000);
}

// ---------------- Profile ----------------
document.getElementById("saveProfileBtn").addEventListener("click",()=>{
    const newNick = document.getElementById("customNick").value.trim();
    if(newNick) user = newNick;
    const color = document.getElementById("colorSelect").value;
    document.getElementById("score").style.color = color;
    saveScore();
});

// ---------------- Online ----------------
function appearOnline(){ setInterval(()=> db.ref("online/"+user).set(Date.now()),1000); }
function listenOnline(){
    db.ref("online").on("value",snap=>{
        const data = snap.val()||{};
        const now = Date.now();
        let html="";
        for(let u in data) if(now-data[u]<3000) html+=`<div class="item">${u}</div>`;
        document.getElementById("online").innerHTML = html;
    });
}

// ---------------- Leaderboard ----------------
function listenLeaderboard(){
    db.ref("users").on("value",snap=>{
        const data = snap.val()||{};
        let arr=[];
        for(let u in data) arr.push({name:u,score:data[u].score||0,photo:data[u].photo||null});
        arr.sort((a,b)=>b.score-a.score);
        let html="";
        arr.forEach((p,i)=>{
            let icon = p.photo ? `<img src="${p.photo}">` : "";
            html+=`<div class="item">${icon}${i+1}. ${p.name} — ${p.score}</div>`;
        });
        document.getElementById("leaders").innerHTML=html;
    });
}
</script>
</body>
</html>
